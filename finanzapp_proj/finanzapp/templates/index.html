{% extends 'base.html' %}
{% load humanize %}
{% load static %}
{% block content %}
<div class="app-shell">
    <section class="panel hero">
        <div class="hero-grid">
            <div>
                <span class="eyebrow">Panel principal</span>
                <h1>Bienvenido(a) {{ user.display_name }}</h1>
                <p class="lead">Controla tu presupuesto, tu ahorro y tus gastos sin perder el detalle.</p>
                <div class="stat-grid">
                    <div class="stat-card {% if budget < 0 %}stat-danger{% endif %}">
                        <span class="stat-label">Presupuesto restante</span>
                        <strong class="stat-value">{{ budget|floatformat:0|intcomma }}</strong>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Gastado este mes</span>
                        <strong class="stat-value">{{ gastos|floatformat:0|intcomma }}</strong>
                    </div>
                </div>
            </div>
            <div class="hero-actions">
                <div class="mini-panel">
                    <div class="section-header">
                        <div>
                            <h3>Mes activo</h3>
                            <p class="text-muted">Selecciona el mes que quieres revisar.</p>
                        </div>
                    </div>
                    <form method="get" class="stack">
                        <input type="month" name="month" value="{{ month_label }}" class="form-control" />
                        <button type="submit" class="btn bg-dark btn-lg px-3 text-light">Cambiar mes</button>
                    </form>
                </div>
                <div class="mini-panel" x-data="gmailSync('{{ month_label }}', '{{ today }}')">
                    <div class="section-header">
                        <div>
                            <h3>Sincronización Gmail</h3>
                            <p class="text-muted">Importa compras con un click.</p>
                        </div>
                    </div>
                    {% if gmail_connected %}
                        <div class="stack">
                            <button id="gmail-sync" class="btn btn-outline-dark btn-lg px-3" data-month="{{ month_label }}" @click="sync" :disabled="syncing">Sincronizar ahora</button>
                            <button class="btn btn-outline-dark btn-lg px-3" @click="resync" :disabled="syncing">Resincronizar mes</button>
                        </div>
                    {% else %}
                        <a href="{% url 'gmail_connect' %}" class="btn bg-dark btn-lg px-3 text-light">Conectar Gmail</a>
                    {% endif %}
                    <p class="text-muted mt-2" x-text="status"></p>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="section-header">
            <div>
                <span class="eyebrow">Gastos</span>
                <h2>Registrar gasto</h2>
                <p class="text-muted">Agrega una compra manualmente o deja que el sistema la categorice.</p>
            </div>
        </div>
        <div class="split-grid">
            <form method="post" class="panel-form">
                {% csrf_token %}
                <div class="field-grid">
                    {% if categories.count %}
                    <div class="form-group">
                        <label for="category">Categoría</label>
                        <select name="category" id="category">
                            <option value="__auto__">Auto (GPT / reglas)</option>
                            {% for cat in categories %}
                                <option value="{{ cat.name }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="form-group">
                        <label for="description">Descripción</label>
                        <input type="text" name="description" required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Monto</label>
                        <input type="number" name="amount" required>
                    </div>
                    <div class="form-group">
                        <label for="date">Fecha</label>
                        <input type="date" name="date" value="{{ today }}" required>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn bg-dark btn-lg px-3 text-light">Agregar gasto</button>
                </div>
            </form>
            <div class="panel-side">
                <div class="hint-card">
                    <h4>Consejos rápidos</h4>
                    <ul>
                        <li>Usa descripciones claras para mejorar la categorización.</li>
                        <li>Si conectas Gmail, importa compras cuando sincronizas.</li>
                        <li>Revisa tus categorías para ajustar tu presupuesto mensual.</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section class="panel">
        <div class="section-header">
            <div>
                <span class="eyebrow">Resumen</span>
                <h2>Estado del mes</h2>
                <p class="text-muted">Lo esencial para tomar decisiones rápidas.</p>
            </div>
        </div>
        <div class="stat-grid">
            <div class="stat-card">
                <span class="stat-label">Salario</span>
                <strong class="stat-value">{{ month_budget.salary|floatformat:0|intcomma }}</strong>
            </div>
            <div class="stat-card">
                <span class="stat-label">Presupuesto</span>
                <strong class="stat-value">{{ month_budget.budget|floatformat:0|intcomma }}</strong>
            </div>
            <div class="stat-card">
                <span class="stat-label">Ahorro del mes</span>
                <strong class="stat-value">{{ month_savings|floatformat:0|intcomma }}</strong>
            </div>
        </div>
        <p class="text-muted mt-3">Edita este presupuesto en “Organízate”.</p>
    </section>

    <section class="panel">
        <div class="section-header">
            <div>
                <span class="eyebrow">Categorías</span>
                <h2>Tus categorías activas</h2>
                <p class="text-muted">Balancea tus gastos por tipo.</p>
            </div>
        </div>
        <div class="card-grid">
            {% for budget in budgets %}
                {% if budget.name != "ninguna" %}
                    <div class="category-card {% if budget.valid %}category-positive{% else %}category-negative{% endif %}" onclick="window.location='{% url 'list' %}?categories={{ budget.id }}';">
                        <div class="category-header">
                            <h3>{{ budget.name }}</h3>
                            <span class="chip">Saldo</span>
                        </div>
                        <p class="category-amount">{{ budget.amount|floatformat:0|intcomma }}</p>
                        <div class="category-action">
                            <a href="/transferDebt/{{ budget.id }}">Mover saldo</a>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </section>

    <section class="panel">
        <div class="section-header">
            <div>
                <span class="eyebrow">Ahorro</span>
                <h2>Últimos 6 meses</h2>
                <p class="text-muted">Visualiza la tendencia y controla retiros.</p>
            </div>
        </div>
        <div class="split-grid">
            <div>
                <canvas id="savingsChart" height="220"></canvas>
                <div class="stat-card mt-3">
                    <span class="stat-label">Ahorro acumulado</span>
                    <strong class="stat-value">{{ total_savings|floatformat:0|intcomma }}</strong>
                </div>
            </div>
            <div class="panel-side">
                <div class="hint-card">
                    <h4>Registrar retiro</h4>
                    <form method="post" action="{% url 'add_savings_withdrawal' %}" class="stack">
                        {% csrf_token %}
                        <label for="withdraw-date" class="form-label">Fecha</label>
                        <input id="withdraw-date" type="date" name="date" class="form-control" required>
                        <label for="withdraw-amount" class="form-label">Monto</label>
                        <input id="withdraw-amount" type="number" name="amount" class="form-control" required>
                        <label for="withdraw-note" class="form-label">Nota</label>
                        <input id="withdraw-note" type="text" name="note" class="form-control" placeholder="Emergencia, viaje, inversión...">
                        <button type="submit" class="btn bg-dark btn-lg px-3 text-light">Registrar retiro</button>
                    </form>
                </div>
                <div class="list-stack">
                    {% for withdrawal in withdrawals %}
                        <div class="list-card">
                            <strong>{{ withdrawal.amount|floatformat:0|intcomma }}</strong>
                            <span class="text-muted">{{ withdrawal.date }}</span>
                            {% if withdrawal.note %}
                                <span>{{ withdrawal.note }}</span>
                            {% endif %}
                        </div>
                    {% empty %}
                        <p class="text-muted">No hay retiros registrados.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const chartLabels = {{ chart_labels|safe }};
    const chartValues = {{ chart_values|safe }};
    const chartCumulative = {{ chart_cumulative|safe }};
    const ctx = document.getElementById('savingsChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Ahorro mensual',
                    data: chartValues,
                    borderColor: '#4ee6d6',
                    backgroundColor: 'rgba(78, 230, 214, 0.18)',
                    tension: 0.35,
                    fill: true,
                }, {
                    label: 'Ahorro acumulado',
                    data: chartCumulative,
                    borderColor: '#f5b56b',
                    backgroundColor: 'rgba(245, 181, 107, 0.12)',
                    tension: 0.35,
                    fill: false,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: false }
                }
            }
        });
    }

    function gmailSync(month, today) {
        return {
            status: '',
            syncing: false,
            async sync() {
                this.status = 'Sincronizando...';
                this.syncing = true;
                try {
                    let pageToken = null;
                    let createdTotal = 0;
                    let reviewedTotal = 0;
                    let batches = 0;
                    do {
                        const url = new URL('/gmail/sync/', window.location.origin);
                        url.searchParams.set('date', today);
                        if (pageToken) {
                            url.searchParams.set('page_token', pageToken);
                        }
                        const response = await fetch(url);
                        const data = await response.json();
                        if (!response.ok) {
                            this.status = data.message || 'No se pudo sincronizar Gmail.';
                            return;
                        }
                        createdTotal += data.created || 0;
                        reviewedTotal += data.total || 0;
                        pageToken = data.next_page_token || null;
                        batches += 1;
                        this.status = `Importadas ${createdTotal} compras (revisadas ${reviewedTotal}).`;
                    } while (pageToken && batches < 25);
                    if (pageToken) {
                        this.status = `Importadas ${createdTotal} compras (revisadas ${reviewedTotal}). Continúa para terminar.`;
                    }
                } catch (err) {
                    this.status = 'No se pudo sincronizar Gmail.';
                } finally {
                    this.syncing = false;
                }
            },
            async resync() {
                this.status = 'Resincronizacion mensual iniciada.';
                this.syncing = true;
                const url = new URL('/gmail/sync/', window.location.origin);
                url.searchParams.set('month', month);
                url.searchParams.set('resync', '1');
                url.searchParams.set('async', '1');
                fetch(url).catch(() => {
                    this.status = 'No se pudo resincronizar Gmail.';
                });
                this.syncing = false;
            }
        };
    }

    function showSyncModal() {
        return;
    }

</script>
{% endblock %}
